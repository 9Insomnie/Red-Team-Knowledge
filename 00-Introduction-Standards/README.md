# 红队实战知识库 - 导读与规范

## 红队定义与目标

### 红队 vs 渗透测试的区别

| 维度 | 红队演练 | 渗透测试 |
|------|----------|----------|
| 目标 | 模拟真实APT攻击，检验整体防御体系 | 发现系统和应用的安全漏洞 |
| 范围 | 全范围，包括人员、流程、技术 | 特定的系统或应用 |
| 方法 | 隐蔽、长期、多阶段攻击 | 扫描、漏洞利用 |
| 时间 | 数周到数月 | 几天到几周 |
| 规则 | 严格的ROE约束 | 相对宽松的规则 |

### 红队核心价值
1. **检验检测能力** - 验证蓝队是否能及时发现攻击
2. **测试响应流程** - 评估应急响应机制的有效性
3. **训练人员技能** - 提升安全团队的实战能力
4. **完善安全体系** - 发现安全架构的薄弱环节

---

## ROE (交战规则)

### 法律边界
- **授权范围**: 明确授权的目标系统、IP段、域名
- **时间窗口**: 授权的测试时间段
- **攻击限制**: 禁止攻击未授权的系统
- **数据保护**: 禁止泄露或滥用获取的敏感数据

### 范围界定
```
✅ 允许的攻击目标：
- 授权的网络段: 192.168.1.0/24
- 授权的域名: *.target.com
- 授权的邮箱域名: @target.com
- 授权的员工信息: 公开渠道可获取的信息

❌ 禁止的攻击行为：
- 攻击第三方供应商系统
- 破坏关键业务系统可用性
- 篡改或删除重要数据
- 使用勒索软件等恶意程序
```

### 禁止事项
1. **拒绝服务攻击** - 禁止影响业务连续性
2. **数据破坏** - 禁止删除、篡改关键数据
3. **横向移动** - 未经明确授权不得横向移动到其他网络
4. **持久化** - 测试结束后必须清除所有后门
5. **社交工程** - 禁止造成员工恐慌或心理伤害

---

## OPSEC (行动安全)

### 攻击源隐藏

#### Tor网络使用
```bash
# 安装Tor
sudo apt install tor

# 配置Proxychains
sudo nano /etc/proxychains.conf
# 添加: socks5 127.0.0.1 9050

# 使用Tor进行匿名扫描
proxychains nmap -sT target.com
```

#### VPN链式连接
```bash
# 多层VPN连接
vpn1 -> vpn2 -> vpn3 -> target

# 检查IP泄露
curl ifconfig.me
curl ipinfo.io
```

#### 代理链配置
```bash
# SSH隧道
ssh -D 1080 user@vps1.com
ssh -D 1081 user@vps2.com

# Proxychains配置
echo "socks5 127.0.0.1 1080" >> /etc/proxychains.conf
echo "socks5 127.0.0.1 1081" >> /etc/proxychains.conf
```

### 身份伪装与数字足迹擦除

#### 身份构建
```
基础信息：
- 姓名: Alex Chen (常见英文名)
- 职业: IT顾问/自由开发者
- 邮箱: alex.chen.dev@protonmail.com
- 社交媒体: LinkedIn技术专家身份
```

#### 数字足迹清理
```bash
# 浏览器指纹防护
- 使用Tor Browser或Firefox隐私模式
- 禁用WebRTC防止真实IP泄露
- 使用User-Agent切换器

# 系统信息隐藏
- 修改MAC地址: macchanger -r eth0
- 修改主机名: hostnamectl set-hostname workstation01
- 时区设置: timedatectl set-timezone UTC
```

### 时间控制

#### Jitter (抖动) 配置
```python
# Cobalt Strike jitter设置
set jitter 30;  # 30%随机抖动
set sleep 60;   # 基础60秒心跳

# 实际效果: 42-78秒随机间隔
```

#### 工作时间模拟
```python
# Python脚本模拟工作时间
import random
import time
from datetime import datetime

def smart_sleep():
    now = datetime.now()
    
    # 工作时间: 9:00-18:00
    if 9 <= now.hour < 18:
        base_sleep = random.randint(300, 900)  # 5-15分钟
    else:
        base_sleep = random.randint(1800, 3600)  # 30-60分钟
    
    # 添加随机抖动
    jitter = random.randint(-50, 50)
    actual_sleep = max(60, base_sleep + jitter)
    
    time.sleep(actual_sleep)
```

---

## MITRE ATT&CK 映射

### 战术与技术速查表

#### 初始访问 (Initial Access)
| 技术ID | 技术名称 | 典型场景 |
|--------|----------|----------|
|T1566.001| 钓鱼附件 | Office宏文档 |
|T1190 | 利用公开漏洞 | VPN、Exchange漏洞 |
|T1078 | 有效账户 | 弱口令、凭证复用 |

#### 执行 (Execution)
| 技术ID | 技术名称 | 典型场景 |
|--------|----------|----------|
|T1059.001| PowerShell | 无文件攻击 |
|T1053.005| 计划任务 | 持久化机制 |
|T1047 | WMI | 远程执行命令 |

#### 持久化 (Persistence)
| 技术ID | 技术名称 | 典型场景 |
|--------|----------|----------|
|T1547.001| 注册表运行键 | 开机自启动 |
|T1053.005| 计划任务 | 定时执行 |
|T1543.003| Windows服务 | 服务替换 |

#### 权限提升 (Privilege Escalation)
| 技术ID | 技术名称 | 典型场景 |
|--------|----------|----------|
|T1055 | 进程注入 | DLL注入 |
|T1078 | 有效账户 | 管理员账户 |
|T1134 | 访问令牌操作 | Token窃取 |

#### 防御规避 (Defense Evasion)
| 技术ID | 技术名称 | 典型场景 |
|--------|----------|----------|
|T1027 | 混淆文件或信息 | 代码混淆 |
|T1055.012| 进程注入: 线程劫持 |
|T1218.007| 签名二进制代理执行: Msiexec |

#### 凭证访问 (Credential Access)
| 技术ID | 技术名称 | 典型场景 |
|--------|----------|----------|
|T1003.001| LSASS内存 | Mimikatz |
|T1558.003| Kerberoasting | TGS票据破解 |
|T1212 | 利用认证机制 | Pass-the-Hash |

#### 发现 (Discovery)
| 技术ID | 技术名称 | 典型场景 |
|--------|----------|----------|
|T1083 | 文件发现 | 敏感文件搜索 |
|T1057 | 进程发现 | 运行进程枚举 |
|T1018 | 远程系统发现 | 网络扫描 |

#### 横向移动 (Lateral Movement)
| 技术ID | 技术名称 | 典型场景 |
|--------|----------|----------|
|T1021.001| 远程桌面协议 | RDP连接 |
|T1021.002| SMB/Windows管理员共享 | PsExec |
|T1047 | WMI | 远程命令执行 |

#### 收集 (Collection)
| 技术ID | 技术名称 | 典型场景 |
|--------|----------|----------|
|T1005 | 本地数据收集 | 敏感文件收集 |
|T1039 | 数据网络共享 | 共享文件夹 |
|T1114.001| 本地邮件收集 | Outlook数据 |

#### 命令控制 (Command and Control)
| 技术ID | 技术名称 | 典型场景 |
|--------|----------|----------|
|T1071.001| 应用层协议: Web协议 | HTTP/HTTPS |
|T1090.001| 代理: 内部代理 | 代理转发 |
|T1573 | 加密通道 | TLS/SSL |

#### 渗出 (Exfiltration)
| 技术ID | 技术名称 | 典型场景 |
|--------|----------|----------|
|T1041 | 通过C2通道渗出 | 代理传输 |
|T1567.002| Web服务: 文件共享 | 云存储 |
|T1020 | 自动化渗出 | 定时任务 |

#### 影响 (Impact)
| 技术ID | 技术名称 | 典型场景 |
|--------|----------|----------|
|T1486 | 数据加密影响 | 勒索软件 |
|T1490 | 抑制系统恢复 | 备份删除 |
|T1491.001| 数据操纵: 存储数据 | 数据篡改 |

### 实战应用示例

#### 完整攻击链映射
```
1. 初始访问 [T1566.001] -> 钓鱼邮件附件
2. 执行 [T1059.001] -> PowerShell下载器
3. 持久化 [T1547.001] -> 注册表自启动
4. 权限提升 [T1055] -> DLL注入
5. 防御规避 [T1027] -> 代码混淆
6. 发现 [T1018] -> 网络扫描
7. 横向移动 [T1021.002] -> PsExec
8. 收集 [T1005] -> 敏感文件
9. 渗出 [T1041] -> C2通道传输
```

#### 检测规则编写
```yaml
# Sigma规则示例
title: Mimikatz使用检测
description: 检测LSASS进程访问
logsource:
    product: windows
category: process_access
detection:
    selection:
        TargetImage: '*lsass.exe'
        GrantedAccess: 
            - '0x1010'
            - '0x1410'
    condition: selection
level: high
```

---

## 快速参考检查清单

### 行动前检查
- [ ] ROE文档已签署
- [ ] 目标范围已确认
- [ ] 攻击时间窗口已规划
- [ ] 应急联系渠道已建立
- [ ] 数据保护协议已确认

### 行动中检查
- [ ] OPSEC措施已实施
- [ ] 攻击源已隐藏
- [ ] 时间控制已配置
- [ ] 日志清理已计划
- [ ] 蓝队沟通渠道畅通

### 行动后检查
- [ ] 所有后门已清除
- [ ] 所有账户已禁用
- [ ] 所有工具已删除
- [ ] 所有日志已清理
- [ ] 测试报告已提交